<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provocation Testing</title>
    <style>
        :root {
            --main-bg: #1d1212;
            --text-color: #111;
            --border-color: #111;
            --box-bg: #fff;
        }
        body { font-family: 'Courier New', Courier, monospace; background-color: var(--main-bg); color: var(--text-color); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 2rem; box-sizing: border-box; text-align: center; }
        main { width: 100%; max-width: 600px; }
        #provocation-container { min-height: 250px; border: 1px solid var(--border-color); padding: 2rem 3rem; display: flex; justify-content: center; align-items: center; margin-bottom: 2rem; background-color: var(--box-bg); }
        #provocation-text { font-size: 1.2rem; line-height: 1.7; text-align: left; width: 100%; }
        .task-separator { display: block; text-align: left; margin: 2.5rem 0 1rem 0; }
        #provocation-container.loading #provocation-text, #provocation-container.error #provocation-text { font-size: 1.1rem; text-align: center; width: 100%; }
        #provocation-container.error #provocation-text { color: #d90429; }
        
        /* --- Styles for the voting buttons --- */
        #vote-container { display: flex; justify-content: space-around; gap: 2rem; }
        .vote-btn { background: var(--box-bg); border: 1px solid var(--border-color); font-size: 4rem; padding: 1rem 2rem; cursor: pointer; transition: transform 0.1s; width: 100%; }
        .vote-btn:hover { transform: scale(1.05); }
        .vote-btn:active { transform: scale(0.98); }
    </style>
</head>
<body>
    <main>
        <div id="provocation-container" class="loading">
            <p id="provocation-text">Loading provocation deck...</p>
        </div>
        <div id="vote-container">
            <button id="downvote-btn" class="vote-btn">üëé</button>
            <button id="upvote-btn" class="vote-btn">üëç</button>
        </div>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM Elements ---
            const provocationContainer = document.getElementById('provocation-container');
            const provocationTextEl = document.getElementById('provocation-text');
            const upvoteBtn = document.getElementById('upvote-btn');
            const downvoteBtn = document.getElementById('downvote-btn');

            // --- State Variables ---
            let unvotedProvocations = [];
            let currentIndex = 0;

            /**
             * Initializes the testing interface by fetching the deck of unvoted cards.
             */
            async function initialize() {
                try {
                    const response = await fetch('/get_unvoted_provocations');
                    unvotedProvocations = await response.json();
                    
                    if (unvotedProvocations.length > 0) {
                        shuffleArray(unvotedProvocations);
                        displayCurrentProvocation();
                    } else {
                        showCompletionMessage();
                    }

                } catch (error) {
                    console.error("Initialization Error:", error);
                    provocationContainer.classList.add('error');
                    provocationTextEl.textContent = "Error: Could not connect to the testing server. Is it running?";
                } finally {
                    provocationContainer.classList.remove('loading');
                }

                upvoteBtn.addEventListener('click', () => handleVote('up'));
                downvoteBtn.addEventListener('click', () => handleVote('down'));
            }

            /**
             * Displays the provocation at the current index.
             */
            function displayCurrentProvocation() {
                const provocation = unvotedProvocations[currentIndex];
                renderProvocation(provocation);
            }

            /**
             * Handles a vote click, sends the data to the server, and shows the next card.
             */
            async function handleVote(vote) {
                const currentProvocation = unvotedProvocations[currentIndex];

                try {
                    await fetch('/vote', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...currentProvocation, vote: vote })
                    });
                } catch (error) {
                    console.error("Failed to submit vote:", error);
                    provocationTextEl.textContent = "Error saving vote. Please check the server.";
                    return;
                }

                currentIndex++;
                if (currentIndex >= unvotedProvocations.length) {
                    showCompletionMessage();
                } else {
                    displayCurrentProvocation();
                }
            }
            
            function showCompletionMessage() {
                 provocationTextEl.innerHTML = `
                    <span style="text-align: center; width:100%;">
                        <strong>All Done!</strong><br><br>You have rated all available provocations.
                    </span>
                `;
                upvoteBtn.disabled = true;
                downvoteBtn.disabled = true;
                upvoteBtn.style.opacity = 0.3;
                downvoteBtn.style.opacity = 0.3;
            }

            function renderProvocation({ setup, task }) {
                provocationTextEl.innerHTML = `
                    <span class="setup-text">${setup}</span>
                    <span class="task-separator"><u>YOUR TASK</u></span>
                    <span class="task-text">${task}</span>
                `;
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            initialize();
        });
    </script>
</body>
</html>