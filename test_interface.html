<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provocation Testing</title>
    <style>
        :root {
            --main-bg: #1d1212;
            --text-color: #111;
            --border-color: #111;
            --box-bg: #fff;
        }
        body { font-family: 'Courier New', Courier, monospace; background-color: var(--main-bg); color: var(--text-color); display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; margin: 0; padding: 2rem; box-sizing: border-box; text-align: center; }
        main { width: 100%; max-width: 600px; }
        #provocation-container { min-height: 250px; border: 1px solid var(--border-color); padding: 2rem 3rem; display: flex; justify-content: center; align-items: center; margin-bottom: 2rem; background-color: var(--box-bg); }
        #provocation-text { font-size: 1.2rem; line-height: 1.7; text-align: left; width: 100%; }
        .task-separator { display: block; text-align: left; margin: 2.5rem 0 1rem 0; }
        #provocation-container.loading #provocation-text, #provocation-container.error #provocation-text { font-size: 1.1rem; text-align: center; width: 100%; }
        #provocation-container.error #provocation-text { color: #d90429; }
        
        #vote-container { display: flex; justify-content: space-around; gap: 2rem; }
        .vote-btn { background: var(--box-bg); border: 1px solid var(--border-color); font-size: 4rem; padding: 1rem 2rem; cursor: pointer; transition: transform 0.1s; width: 100%; }
        .vote-btn:hover { transform: scale(1.05); }
        .vote-btn:active { transform: scale(0.98); }

        /* --- NEW: Styles for the Download button --- */
        #end-session-btn { background: #4CAF50; color: white; border: none; padding: 1rem 2rem; font-family: inherit; font-size: 1rem; text-transform: uppercase; cursor: pointer; margin-top: 2rem; display: none; /* Hidden by default */ }
        #end-session-btn:hover { background: #45a049; }
    </style>
</head>
<body>
    <main>
        <div id="provocation-container" class="loading">
            <p id="provocation-text">Loading provocation deck...</p>
        </div>
        <div id="vote-container">
            <button id="downvote-btn" class="vote-btn">üëé</button>
            <button id="upvote-btn" class="vote-btn">üëç</button>
        </div>
        <!-- NEW: Download button -->
        <button id="end-session-btn">End Session & Download Scores</button>
    </main>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const provocationContainer = document.getElementById('provocation-container');
            const provocationTextEl = document.getElementById('provocation-text');
            const upvoteBtn = document.getElementById('upvote-btn');
            const downvoteBtn = document.getElementById('downvote-btn');
            const endSessionBtn = document.getElementById('end-session-btn');

            let allProvocations = [];
            let currentIndex = 0;
            // NEW: All scores for this session will be stored here in the browser.
            let sessionScores = [];

            async function initialize() {
                try {
                    // CHANGED: Fetches the entire deck at once.
                    const response = await fetch('/get_all_provocations');
                    allProvocations = await response.json();
                    
                    if (allProvocations.length > 0) {
                        shuffleArray(allProvocations);
                        displayCurrentProvocation();
                    } else {
                        showCompletionMessage();
                    }
                } catch (error) {
                    console.error("Initialization Error:", error);
                    provocationContainer.classList.add('error');
                    provocationTextEl.textContent = "Error: Could not connect to the testing server. Is it running?";
                } finally {
                    provocationContainer.classList.remove('loading');
                }

                upvoteBtn.addEventListener('click', () => handleVote('up'));
                downvoteBtn.addEventListener('click', () => handleVote('down'));
                endSessionBtn.addEventListener('click', downloadScores);
            }

            function displayCurrentProvocation() {
                const provocation = allProvocations[currentIndex];
                renderProvocation(provocation);
            }

            // CHANGED: This function no longer sends data to the server.
            function handleVote(vote) {
                const currentProvocation = allProvocations[currentIndex];

                // 1. Add the score to our in-memory list.
                sessionScores.push({
                    ...currentProvocation,
                    vote: vote
                });

                // 2. Move to the next card.
                currentIndex++;
                if (currentIndex >= allProvocations.length) {
                    showCompletionMessage();
                } else {
                    displayCurrentProvocation();
                }
            }
            
            function showCompletionMessage() {
                 provocationTextEl.innerHTML = `
                    <span style="text-align: center; width:100%;">
                        <strong>All Done!</strong><br><br>You have rated all provocations. Please click the button below to download your results.
                    </span>
                `;
                // Hide voting buttons and show the download button.
                upvoteBtn.style.display = 'none';
                downvoteBtn.style.display = 'none';
                endSessionBtn.style.display = 'block';
            }

            // NEW: This function handles the file download.
            function downloadScores() {
                // Convert the array of scores into a stringified JSON.
                const jsonString = JSON.stringify(sessionScores, null, 2);
                // Create a blob, which is a file-like object.
                const blob = new Blob([jsonString], { type: 'application/json' });
                // Create a temporary URL for the blob.
                const url = URL.createObjectURL(blob);
                
                // Create a temporary link element to trigger the download.
                const a = document.createElement('a');
                a.href = url;
                a.download = 'provocation_scores.json';
                document.body.appendChild(a);
                a.click();
                
                // Clean up by removing the link and revoking the URL.
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            }

            function renderProvocation({ setup, task }) {
                provocationTextEl.innerHTML = `
                    <span class="setup-text">${setup}</span>
                    <span class="task-separator"><u>YOUR TASK</u></span>
                    <span class="task-text">${task}</span>
                `;
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
            }

            initialize();
        });
    </script>
</body>
</html>